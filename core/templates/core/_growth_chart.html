<div class="card mb-4 shadow-sm" id="growthChartCard">
  <div class="card-header bg-success text-white fw-bold">Growth Chart</div>
  <div class="card-body">
    <p class="mb-2">
      <strong>Chart Type:</strong>
      {% if chart_mode == "bmi" %}
        BMI-for-Age (WHO Reference)
      {% elif chart_mode == "wfh" %}
        Weight-for-Height (WHO Reference)
      {% else %}
        Growth Tracking
      {% endif %}
    </p>

    <div id="bmiChartWrapper" class="mb-4" {% if not bmi_labels or bmi_labels|length == 0 %}style="display:none;"{% endif %}>
      <div id="bmiChart" style="width:100%;height:500px;"></div>
    </div>

    <div id="wfhChartWrapper" {% if not wfh_labels or wfh_labels|length == 0 %}style="display:none;"{% endif %}>
      <div id="wfhChart" style="width:100%;height:500px;"></div>
    </div>

    {% if not chart_labels %}
      <p class="text-muted">No growth data available for this student yet.</p>
    {% endif %}
  </div>
</div>

<script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>

{% if chart_mode != "none" %}
<script>
document.addEventListener("DOMContentLoaded", () => {

    const bmiLabels = JSON.parse(`{{ bmi_labels|default:"[]"|escapejs }}`);
    const bmiValues = JSON.parse(`{{ bmi_values|default:"[]"|escapejs }}`);
    const bmiCats   = JSON.parse(`{{ bmi_categories|default:"[]"|escapejs }}`);

    const wfhLabels = JSON.parse(`{{ wfh_labels|default:"[]"|escapejs }}`);
    const wfhValues = JSON.parse(`{{ wfh_values|default:"[]"|escapejs }}`);
    const wfhCats   = JSON.parse(`{{ wfh_categories|default:"[]"|escapejs }}`);

    const whoCurves = JSON.parse(`{{ chart_who_curves|default:"{}"|escapejs }}`);

    const colorMap = {
        "Severe Acute Malnutrition": "red",
        "Moderate Acute Malnutrition": "orange",
        "Normal": "green",
        "Overweight": "blue",
        "Obese": "purple",
        "N/A": "gray"
    };

    const sdColors = [
        "rgba(255,0,0,0.4)", "rgba(255,100,0,0.4)", "rgba(255,165,0,0.4)",
        "rgba(0,150,0,0.4)", "rgba(0,100,255,0.4)", "rgba(100,0,255,0.4)",
        "rgba(150,0,150,0.4)"
    ];

    const sdLabels = ["-3SD","-2SD","-1SD","Median","+1SD","+2SD","+3SD"];

    function buildWhoTraces(mapToAge) {
        return sdLabels
            .filter(label => whoCurves[label]?.x && whoCurves[label]?.y)
            .map((label, i) => ({
                x: mapToAge
                    ? whoCurves[label].x.map(m => `${Math.floor(m/12)}y ${m%12}m`)
                    : whoCurves[label].x,
                y: whoCurves[label].y,
                mode: "lines",
                name: label,
                line: { width: label === "Median" ? 2.5 : 1.2, color: sdColors[i] },
                hoverinfo: "none",
                showlegend: true
            }));
    }

    // --------------------------- BMI CHART ---------------------------
    if (bmiLabels.length && bmiValues.length) {
        const studentTrace = {
            x: bmiLabels.map(m => `${Math.floor(m/12)}y ${m%12}m`),
            y: bmiValues,
            mode: "markers+lines",
            name: "Student",
            marker: {
                size: 10,
                color: bmiCats.map(c => colorMap[c] || "gray"),
                line: { width: 1, color: "#222" }
            }
        };

        Plotly.newPlot("bmiChart", [...buildWhoTraces(true), studentTrace], {
            title: "BMI-for-Age (WHO)",
            xaxis: { title: "" },
            yaxis: { title: "BMI (kg/mÂ²)" },
            legend: { orientation: "h", y: -0.2 }
        });
    } else {
        document.getElementById("bmiChartWrapper").style.display = "none";
    }

    // --------------------------- WFH CHART ---------------------------
    if (wfhLabels.length && wfhValues.length) {
        const studentTrace = {
            x: wfhLabels,
            y: wfhValues,
            mode: "markers+lines",
            name: "Student",
            marker: {
                size: 10,
                color: wfhCats.map(c => colorMap[c] || "gray"),
                line: { width: 1, color: "#222" }
            }
        };

        Plotly.newPlot("wfhChart", [...buildWhoTraces(false), studentTrace], {
            title: "Weight-for-Height (WHO)",
            xaxis: { title: "Height (cm)" },
            yaxis: { title: "Weight (kg)" },
            legend: { orientation: "h", y: -0.2 }
        });
    } else {
        document.getElementById("wfhChartWrapper").style.display = "none";
    }

});
</script>
{% endif %}
