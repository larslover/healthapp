{% extends "core/base.html" %}
{% load custom_filters %}

{% block title %}Screening Summary{% endblock %}

{% block content %}
<div class="container my-4">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold">Screening Summary</h2>
    <div>
      <a href="{% url 'screened_students' %}" class="btn btn-outline-secondary me-2">&laquo; Back to List</a>
      {% if user.is_staff %}
        <a href="{% url 'screening_list' %}" class="btn btn-primary">Add Screening</a>
      {% endif %}
    </div>
  </div>

  <!-- Filters -->
  <form method="get" class="row g-3 mb-4">
    <div class="col-md-4">
      <label for="schoolSelect" class="form-label">Select School</label>
      <select name="school" id="schoolSelect" class="form-select" onchange="this.form.submit()">
        <option value="">-- Select School --</option>
        {% for school in schools %}
          <option value="{{ school.id }}" {% if selected_school_id == school.id %}selected{% endif %}>
            {{ school.name }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-4">
      <label for="studentSelect" class="form-label">Select Student</label>
      <select name="student" id="studentSelect" class="form-select" onchange="this.form.submit()">
        <option value="">-- Select Student --</option>
        {% for s in students %}
          <option value="{{ s.id }}" {% if selected_student_id == s.id %}selected{% endif %}>
            {{ s.name }} ({{ s.current_class_section|default:"—" }})
          </option>
        {% endfor %}
      </select>
    </div>
  </form>

  {% if student %}
  <!-- Student Info -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
      <span>Student Information</span>
      <button class="btn btn-sm btn-light" data-bs-toggle="collapse" data-bs-target="#studentInfoBody">Hide</button>
    </div>
    <div id="studentInfoBody" class="collapse show">
      <div class="card-body">
        <div class="row mb-2"><div class="col-md-3"><strong>Name:</strong></div><div class="col-md-9">{{ student.name }}</div></div>
        <div class="row mb-2"><div class="col-md-3"><strong>Gender:</strong></div><div class="col-md-9">{{ student.gender|default:"—" }}</div></div>
        <div class="row mb-2"><div class="col-md-3"><strong>School:</strong></div><div class="col-md-9">{{ student.school.name|default:"—" }}</div></div>
        <div class="row mb-2"><div class="col-md-3"><strong>Date of Birth:</strong></div><div class="col-md-9">{{ student.date_of_birth|date:"Y-m-d" }}</div></div>
        <div class="row mb-2"><div class="col-md-3"><strong>Age:</strong></div><div class="col-md-9">{{ student.age_in_years }} years</div></div>
        <div class="row mb-2"><div class="col-md-3"><strong>Father/Guardian:</strong></div><div class="col-md-9">{{ student.father_or_guardian_name|default:"—" }}</div></div>
        <div class="row mb-2"><div class="col-md-3"><strong>Known Earlier Disease:</strong></div><div class="col-md-9 text-danger">{{ student.known_earlier_disease|default:"—" }}</div></div>
      </div>
    </div>
  </div>

  {% if screenings %}
  <!-- Growth Summary Chart -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
      <span>Growth Summary</span>
      <button class="btn btn-sm btn-light" data-bs-toggle="collapse" data-bs-target="#growthChartBody">Hide</button>
    </div>

    <div id="growthChartBody" class="collapse show">
      <div class="card-body">
        <div class="mb-2">
          <strong>Chart Type:</strong>
          <span id="chartTypeLabel" class="badge bg-info text-dark"></span>
        </div>
        <canvas id="growthChart" height="250"></canvas>
      </div>
    </div>
  </div>

  <!-- Individual Screenings -->
  {% for screening in screenings %}
  <div class="card mb-3 shadow-sm">
    <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
      <span>{{ screening.screen_date|date:"Y-m-d" }}</span>
      <button class="btn btn-sm btn-light" data-bs-toggle="collapse" data-bs-target="#screeningBody{{ screening.id }}">Hide</button>
    </div>

    <div id="screeningBody{{ screening.id }}" class="collapse show">
      <div class="card-body">
        {% with age_months=student.date_of_birth|months_at_screening:screening.screen_date %}

        <div class="row mb-2">
          <div class="col-md-2"><strong>Weight:</strong> {{ screening.weight|default:"—" }} kg</div>
          <div class="col-md-2"><strong>Height:</strong> {{ screening.height|default:"—" }} cm</div>
          <div class="col-md-2"><strong>Age:</strong> {{ student.date_of_birth|age_at_screening:screening.screen_date }}</div>

          {% if age_months >= 60 %}
          <div class="col-md-2">
            <strong>BMI:</strong> {{ screening.bmi|default:"—" }}
            {% if screening.bmi_category and screening.bmi_category|lower != "normal" %}
              <span class="text-danger">({{ screening.bmi_category }})</span>
            {% endif %}
          </div>
          {% endif %}

          {% if 6 <= age_months <= 60 %}
          <div class="col-md-2">
            <strong>MUAC:</strong> {{ screening.muac|default:"—" }}
            {% if screening.muac_category and screening.muac_category|lower != "normal" %}
              <span class="text-danger">({{ screening.muac_category }})</span>
            {% endif %}
          </div>
          {% endif %}
        </div>

        {% if 24 <= age_months <= 60 %}
        <div class="row mb-2">
          <div class="col-md-4">
            <strong>Weight-for-Height:</strong>
            {% if screening.weight_for_height %}
              {% if "normal" not in screening.weight_for_height|lower %}
                <span class="text-danger">{{ screening.weight_for_height }}</span>
              {% else %}
                {{ screening.weight_for_height }}
              {% endif %}
            {% else %}
              —
            {% endif %}
          </div>
        </div>
        {% endif %}
        {% endwith %}

        <!-- Vision -->
        <div class="row mb-2">
          <div class="col-md-3"><strong>Vision (Left):</strong> {{ screening.vision_left|default:"—" }}</div>
          <div class="col-md-3"><strong>Vision (Right):</strong> {{ screening.vision_right|default:"—" }}</div>
          <div class="col-md-3"><strong>Vision (Both):</strong> {{ screening.vision_both|default:"—" }}</div>
          <div class="col-md-3">
            <strong>Vision Problem:</strong>
            {% if screening.vision_problem == "yes" %}
              <span class="text-danger">Yes</span>
            {% else %}
              <span class="text-muted">No</span>
            {% endif %}
          </div>
        </div>

        <!-- Checklist -->
        {% if screening.checklist_dict %}
        <div class="mt-3">
          <h6 class="text-primary">Checklist</h6>
          <div class="mt-2">
            {% for group_name, fields in checklist_groups.items %}
              {% if group_name != "Preventive Care" and group_name != "Other Observations" %}
                <div class="row">
                  {% for field_name in fields %}
                    {% if screening.checklist_dict|dict_get:field_name %}
                      <div class="col-md-3">
                        <strong>{{ field_name|capfirst }}:</strong> ✅
                      </div>
                    {% endif %}
                  {% endfor %}
                </div>
              {% endif %}
            {% endfor %}
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
  {% endfor %}
  {% else %}
    <p class="text-muted">No screenings found for this student.</p>
  {% endif %}
  {% endif %}
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% if screenings %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
  document.addEventListener("DOMContentLoaded", function() {
    const ctx = document.getElementById("growthChart");
    if (!ctx) return;

    const chartTypeLabel = document.getElementById("chartTypeLabel");
    const ageMonths = {{ student.age_in_months|default:0 }};

    let chartTitle = "";
    if (ageMonths >= 24 && ageMonths <= 60) {
      chartTitle = "Weight-for-Height (WHO)";
    } else if (ageMonths > 60) {
      chartTitle = "BMI-for-Age (WHO)";
    } else {
      chartTitle = "Growth Tracking";
    }
    chartTypeLabel.textContent = chartTitle;

    new Chart(ctx, {
      type: 'line',
      data: {
        labels: {{ chart_labels|safe }},
        datasets: [
          {
            label: chartTitle,
            data: {{ chart_values|safe }},
            borderColor: 'rgba(54,162,235,1)',
            backgroundColor: 'rgba(54,162,235,0.2)',
            tension: 0.3,
            fill: true
          }
        ]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'top' },
          title: { display: true, text: chartTitle }
        },
        scales: { y: { beginAtZero: true } }
      }
    });
  });
  </script>
{% endif %}
{% endblock %}
