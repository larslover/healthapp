{% extends "core/base.html" %}
{% block title %}Add Screening{% endblock %}

{% block content %}
<h2 class="mb-4 fw-bold">Add Screening</h2>

<form method="POST" class="needs-validation" novalidate>
    {% csrf_token %}

    <!-- School Selection -->
    <div class="mb-4">
        <label class="form-label">Select School</label>
        <select id="schoolSelect" class="form-select">
            <option value="">-- All Schools --</option>
            {% for school in schools %}
                <option value="{{ school.id }}">{{ school.name }}</option>
            {% endfor %}
        </select>
    </div>

    <!-- Student Selection -->
    <div class="mb-4">
        <label class="form-label">Select Existing Student</label>
        <select id="studentSelect" name="student" class="form-select" required>
            <option value="">-- Select a student --</option>
            {% for student in students %}
                <option value="{{ student.id }}">{{ student.name }} ({{ student.current_class_section|default_if_none:"—" }})</option>
            {% endfor %}
        </select>
    </div>

    <!-- Student Details Card -->
    <div id="studentCard" class="card mb-4 d-none">
        <div class="card-header">
            <strong>Student Details</strong>
        </div>
        <div class="card-body" id="studentFormContainer">
            <!-- JS will populate the StudentForm fields here -->
        </div>
    </div>

    <!-- Screening Info -->
    <hr class="my-4">
    <h5 class="mb-3">Screening Details</h5>
    <div class="row g-3">
        {{ screening_form.as_p }}
    </div>

    <!-- Screening Checklist -->
    <hr class="my-4">
    <h5 class="mb-3">Screening Checklist</h5>
    <div class="mb-3" id="muacWrapper">
        {{ screening_form.muac.label_tag }} {{ screening_form.muac }}
    </div>
    
    <div class="row g-3">
        {% for field in screening_check_form %}
            {% if field.name == 'B5_oedema' %}
                <div class="mb-3 fade d-none" id="B5Wrapper">
                    {{ field.label_tag }} {{ field }}
                </div>
            {% elif field.name == 'E4_menarke' %}
                <div class="mb-3 fade d-none" id="E4Wrapper">
                    {{ field.label_tag }} {{ field }}
                </div>
            {% elif field.name == 'E5_regularity_period_difficulties' %}
                <div class="mb-3 fade d-none" id="E5Wrapper">
                    {{ field.label_tag }} {{ field }}
                </div>
            {% elif field.name == 'E8_menstrual_pain' %}
                <div class="mb-3 fade d-none" id="E8Wrapper">
                    {{ field.label_tag }} {{ field }}
                </div>
            {% else %}
                <div class="mb-3">
                    {{ field.label_tag }} {{ field }}
                </div>
            {% endif %}
        {% endfor %}
    </div>

    <div class="mt-4">
        <button type="submit" class="btn btn-primary">Save Screening</button>
    </div>
</form>

<!-- =========================
     JS: Dynamic Visibility, Age Auto-fill, Student Card
========================= -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const studentSelect = document.getElementById('studentSelect');
    const screenDateInput = document.getElementById('id_screen_date');
    const ageField = document.getElementById('id_age_screening');

    const B5Wrapper = document.getElementById('B5Wrapper');
    const E4Wrapper = document.getElementById('E4Wrapper');
    const E5Wrapper = document.getElementById('E5Wrapper');
    const E8Wrapper = document.getElementById('E8Wrapper');
    const muacWrapper = document.getElementById('muacWrapper');
    const muacField = document.getElementById('id_muac');
    const E4Input = document.querySelector('[name="E4_menarke"]');
    const studentCard = document.getElementById('studentCard');
    const studentFormContainer = document.getElementById('studentFormContainer');

    function getTotalMonths(dob, screenDate) {
        if (!dob || !screenDate) return null;
        const birth = new Date(dob);
        const screen = new Date(screenDate);
        let months = (screen.getFullYear() - birth.getFullYear()) * 12 + (screen.getMonth() - birth.getMonth());
        if (screen.getDate() < birth.getDate()) months -= 1;
        return months >= 0 ? Math.floor(months) : null;
    }

    function formatAge(totalMonths) {
        if (totalMonths === null) return '';
        const years = Math.floor(totalMonths / 12);
        const months = totalMonths % 12;
        return `${years}y ${months}m (${totalMonths} months)`;
    }

    function showElement(el) { if (!el) return; el.style.display = 'block'; }
    function hideElement(el) { if (!el) return; el.style.display = 'none'; }

    function toggleE5E8() {
        if (!E4Input) return;
        if (E4Input.checked) {
            showElement(E5Wrapper);
            showElement(E8Wrapper);
        } else {
            hideElement(E5Wrapper);
            hideElement(E8Wrapper);
        }
    }

    function updateVisibility() {
        const selectedId = studentSelect.value;
        const screenDate = screenDateInput?.value;
        if (!selectedId) {
            hideElement(studentCard);
            studentFormContainer.innerHTML = '';
            return;
        }

        // Fetch student data from the server via AJAX
        fetch(`/students/${selectedId}/json/`)
            .then(res => res.json())
            .then(data => {
                populateStudentCard(data);
                const totalMonths = getTotalMonths(data.date_of_birth, screenDate);
                if (ageField) ageField.value = formatAge(totalMonths);

                // Show/hide screening fields
                if (data.gender === 'Female') {
                    showElement(E4Wrapper);
                    toggleE5E8();
                } else {
                    [E4Wrapper, E5Wrapper, E8Wrapper].forEach(hideElement);
                }

                if (totalMonths >= 24 && totalMonths <= 72) showElement(B5Wrapper);
                else hideElement(B5Wrapper);

                if (totalMonths >= 6 && totalMonths <= 60) {
                    showElement(muacWrapper);
                    if (muacField) muacField.disabled = false;
                } else {
                    hideElement(muacWrapper);
                    if (muacField) muacField.disabled = true;
                }
            });
    }

    function populateStudentCard(student) {
        if (!student || !studentFormContainer || !studentCard) return;
        let html = '';
        const fields = {
            'Name': student.name,
            'Date of Birth': student.date_of_birth,
            'Gender': student.gender,
            'Roll No': student.roll_no,
            'Aadhaar No': student.aadhaar_no,
            'Father/Guardian': student.father_or_guardian_name,
            'Mother': student.mother_name,
            'Contact Number': student.contact_number,
            'Address': student.address,
            'Email': student.email,
            'Last School Name': student.last_school_name,
            'Place of Birth': student.place_of_birth,
            'Known Earlier Disease': student.known_earlier_disease,
            'School': student.school_name,
            'Class/Section': student.current_class_section,
            'Current Teacher': student.current_teacher,
            'Tea Garden': student.tea_garden
        };

        for (const [label, value] of Object.entries(fields)) {
            html += `<p><strong>${label}:</strong> ${value || '—'}</p>`;
        }

        studentFormContainer.innerHTML = html;
        showElement(studentCard);
    }

    studentSelect?.addEventListener('change', updateVisibility);
    screenDateInput?.addEventListener('input', updateVisibility);
    screenDateInput?.addEventListener('change', updateVisibility);
    if (E4Input) E4Input.addEventListener('change', toggleE5E8);

    updateVisibility();
});
</script>
{% endblock %}
