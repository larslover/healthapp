{% extends "core/base.html" %}
{% block title %}Add Screening{% endblock %}

{% block content %}
<h2 class="mb-4 fw-bold">Add Screening</h2>

<form method="POST" class="needs-validation" novalidate>
    {% csrf_token %}
<!-- School Selection -->
<div class="mb-4">
  <label class="form-label">Select School</label>
  <select id="schoolSelect" class="form-select">
      <option value="">-- All Schools --</option>
      {% for school in schools %}
          <option value="{{ school.id }}">{{ school.name }}</option>
      {% endfor %}
  </select>
</div>

    <!-- Student Selection -->
    <div class="mb-4">
        <label class="form-label">Select Existing Student</label>
        <select id="studentSelect" name="student" class="form-select" required>
            <option value="">-- Select a student --</option>
            {% for student in students %}
            <option value="{{ student.id }}"
            data-dob="{{ student.date_of_birth|date:'Y-m-d' }}"
            data-gender="{{ student.gender|lower }}"
            data-school="{{ student.school.id }}">
        {{ student.name }} ({{ student.current_class_section|default_if_none:'—' }})
    </option>
    
            {% endfor %}
        </select>
    </div>

    <!-- Screening Info -->
    <hr class="my-4">
    <h5 class="mb-3">Screening Details</h5>
    <div class="row g-3">
        {{ screening_form.as_p }}
    </div>

    <!-- Screening Checklist -->
    <hr class="my-4">
    <h5 class="mb-3">Screening Checklist</h5>
    <div class="row g-3">
        {% for field in screening_check_form %}
            {% if field.name == 'B5_oedema' %}
                <div class="mb-3 fade d-none" id="B5Wrapper">
                    {{ field.label_tag }} {{ field }}
                </div>
            {% elif field.name == 'E4_menarke' %}
                <div class="mb-3 fade d-none" id="E4Wrapper">
                    {{ field.label_tag }} {{ field }}
                </div>
            {% elif field.name == 'E5_regularity_period_difficulties' %}
                <div class="mb-3 fade d-none" id="E5Wrapper">
                    {{ field.label_tag }} {{ field }}
                </div>
            {% elif field.name == 'E8_menstrual_pain' %}
                <div class="mb-3 fade d-none" id="E8Wrapper">
                    {{ field.label_tag }} {{ field }}
                </div>
            {% else %}
                <div class="mb-3">
                    {{ field.label_tag }} {{ field }}
                </div>
            {% endif %}
        {% endfor %}
    </div>

    <div class="mt-4">
        <button type="submit" class="btn btn-primary">Save Screening</button>
    </div>
</form>

<!-- =========================
     JS: Dynamic Visibility
========================= -->
<script>
  const schoolSelect = document.getElementById('schoolSelect');
const studentOptions = Array.from(studentSelect.options);

schoolSelect?.addEventListener('change', function() {
    const selectedSchoolId = this.value;

    studentSelect.innerHTML = ''; // clear dropdown
    // Add default placeholder
    const defaultOption = document.createElement('option');
    defaultOption.value = '';
    defaultOption.textContent = '-- Select a student --';
    studentSelect.appendChild(defaultOption);

    // Filter & append matching students
    studentOptions.forEach(opt => {
        const schoolId = opt.dataset.school;
        if (!selectedSchoolId || schoolId === selectedSchoolId) {
            studentSelect.appendChild(opt);
        }
    });

    // Reset selection
    studentSelect.value = '';
    toggleVisibility(); // refresh visibility logic
});

document.addEventListener('DOMContentLoaded', function() {
    const studentSelect = document.getElementById('studentSelect');
    const screenDateInput = document.getElementById('id_screen_date');
    const B5Wrapper = document.getElementById('B5Wrapper');
    const E4Wrapper = document.getElementById('E4Wrapper');
    const E5Wrapper = document.getElementById('E5Wrapper');
    const E8Wrapper = document.getElementById('E8Wrapper');
    const E4Input = document.querySelector('[name="E4_menarke"]');

    // Helper: Calculate age in months
    function calculateAgeInMonths(dob, screenDate) {
        if (!dob || !screenDate) return null;
        const birth = new Date(dob);
        const screen = new Date(screenDate);
        let months = (screen.getFullYear() - birth.getFullYear()) * 12 + (screen.getMonth() - birth.getMonth());
        if (screen.getDate() < birth.getDate()) months -= 1;
        return months;
    }

    // Show/Hide with fade
    function showElement(el) {
        if (!el) return;
        el.classList.remove('d-none');
        setTimeout(() => el.classList.add('show'), 10);
    }
    function hideElement(el) {
        if (!el) return;
        el.classList.remove('show');
        setTimeout(() => el.classList.add('d-none'), 150);
    }

    // Main logic
    function toggleVisibility() {
        const selectedOption = studentSelect.selectedOptions[0];
        if (!selectedOption) {
            [B5Wrapper, E4Wrapper, E5Wrapper, E8Wrapper].forEach(hideElement);
            return;
        }

        const dob = selectedOption.dataset.dob;
        const gender = selectedOption.dataset.gender;
        const screenDate = screenDateInput?.value;

        // Show E4 (and potentially E5/E8) only for female
        if (gender === 'female') {
            showElement(E4Wrapper);
            toggleE5E8();
        } else {
            [E4Wrapper, E5Wrapper, E8Wrapper].forEach(hideElement);
        }

        // B5: show if 24–72 months
        if (dob && screenDate) {
            const ageInMonths = calculateAgeInMonths(dob, screenDate);
            if (ageInMonths >= 24 && ageInMonths <= 72) showElement(B5Wrapper);
            else hideElement(B5Wrapper);
        } else {
            hideElement(B5Wrapper);
        }
    }

    // When E4 checked, show E5 & E8
    function toggleE5E8() {
        if (!E4Input) return;
        if (E4Input.checked) {
            showElement(E5Wrapper);
            showElement(E8Wrapper);
        } else {
            hideElement(E5Wrapper);
            hideElement(E8Wrapper);
        }
    }

    // Attach listeners
    if (studentSelect) studentSelect.addEventListener('change', toggleVisibility);
    if (screenDateInput) {
        screenDateInput.addEventListener('input', toggleVisibility);
        screenDateInput.addEventListener('change', toggleVisibility);
    }
    if (E4Input) E4Input.addEventListener('change', toggleE5E8);

    // Initialize
    toggleVisibility();
});
</script>
{% endblock %}
