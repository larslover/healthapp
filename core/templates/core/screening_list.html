{% extends "core/base.html" %}
{% block title %}Add Screening{% endblock %}

{% block content %}
<h2 class="mb-4 fw-bold">Add Screening</h2>

<form method="POST" class="needs-validation" novalidate>
    {% csrf_token %}

    <!-- Existing Student Selection -->
    <div class="mb-4">
        <label class="form-label">Select Existing Student</label>
        <select id="studentSelect" name="student" class="form-select">
            <option value="">-- Select a student --</option>
            {% for student in students %}
                <option 
                    value="{{ student.id }}" 
                    data-gender="{{ student.gender|default_if_none:''|escapejs }}"
                >
                    {{ student.name }} ({{ student.current_class_section|default_if_none:'â€”' }})
                </option>
            {% endfor %}
        </select>
    </div>

    <!-- Screening Info -->
    <hr class="my-4">
    <h5 class="mb-3">Screening Details</h5>
    <div class="row g-3">
        {{ screening_form.as_p }}
    </div>

    <div class="mt-4">
        <button type="submit" class="btn btn-primary">Save Screening</button>
    </div>
</form>
<script>
  document.addEventListener('DOMContentLoaded', function() {
      const select = document.getElementById('studentSelect');
      const weightInput = document.getElementById('id_weight');
      const heightInput = document.getElementById('id_height');
      const bmiInput = document.getElementById('id_bmi');  // the numeric BMI field
      const bmiCategoryInput = document.getElementById('id_bmi_category'); // category field
  
      function getBmiCategory(gender, month, bmiValue) {
          if (!gender || !month || !bmiValue) return '';
          gender = gender.toLowerCase();
          // Replace with your real thresholds
          if (bmiValue < 14) return 'Severe Underweight';
          if (bmiValue < 16) return 'Underweight';
          if (bmiValue < 20) return 'Normal';
          if (bmiValue < 25) return 'Overweight';
          return 'Obese';
      }
  
      function updateBmiAndCategory() {
          const weight = parseFloat(weightInput.value);
          const height = parseFloat(heightInput.value);
          const selectedOption = select.selectedOptions[0];
          const gender = selectedOption ? selectedOption.dataset.gender : '';
          const month = 60; // or fetch actual age_in_month if available
  
          if (!weight || !height) {
              bmiInput.value = '';
              bmiCategoryInput.value = '';
              return;
          }
  
          const bmi = weight / ((height / 100) ** 2);
          bmiInput.value = bmi.toFixed(2); // update BMI numeric value
          bmiCategoryInput.value = getBmiCategory(gender, month, bmi); // update category
      }
  
      weightInput.addEventListener('input', updateBmiAndCategory);
      heightInput.addEventListener('input', updateBmiAndCategory);
      select.addEventListener('change', updateBmiAndCategory);
  });
  </script>
  
{% endblock %}
