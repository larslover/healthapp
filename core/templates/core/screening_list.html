{% extends "core/base.html" %}
{% block title %}Add Screening{% endblock %}

{% block content %}
<h2 class="mb-4 fw-bold">Add Screening</h2>

<form method="POST" class="needs-validation" novalidate>
    {% csrf_token %}
<!-- School Selection -->
<div class="mb-4">
  <label class="form-label">Select School</label>
  <select id="schoolSelect" class="form-select">
      <option value="">-- All Schools --</option>
      {% for school in schools %}
          <option value="{{ school.id }}">{{ school.name }}</option>
      {% endfor %}
  </select>
</div>

    <!-- Student Selection -->
    <div class="mb-4">
        <label class="form-label">Select Existing Student</label>
        <select id="studentSelect" name="student" class="form-select" required>
            <option value="">-- Select a student --</option>
            {% for student in students %}
            <option value="{{ student.id }}"
            data-dob="{{ student.date_of_birth|date:'Y-m-d' }}"
            data-gender="{{ student.gender|lower }}"
            data-school="{{ student.school.id }}">
        {{ student.name }} ({{ student.current_class_section|default_if_none:'—' }})
    </option>
    
            {% endfor %}
        </select>
    </div>

    <!-- Screening Info -->
    <hr class="my-4">
    <h5 class="mb-3">Screening Details</h5>
    <div class="row g-3">
        {{ screening_form.screen_date.label_tag }} {{ screening_form.screen_date }}
        {{ screening_form.class_section.label_tag }} {{ screening_form.class_section }}
        {{ screening_form.school.label_tag }} {{ screening_form.school }}
        {{ screening_form.age_screening.label_tag }} {{ screening_form.age_screening }}
        {{ screening_form.weight.label_tag }} {{ screening_form.weight }}
        {{ screening_form.height.label_tag }} {{ screening_form.height }}
        {{ screening_form.vision_both.label_tag }} {{ screening_form.vision_both }}
        {{ screening_form.vision_left.label_tag }} {{ screening_form.vision_left }}
        {{ screening_form.vision_right.label_tag }} {{ screening_form.vision_right }}
    </div>
    

    <!-- Screening Checklist -->
    <hr class="my-4">
    <h5 class="mb-3">Screening Checklist</h5>
    <div class="mb-3" id="muacWrapper">
        {{ screening_form.muac.label_tag }} {{ screening_form.muac }}
    </div>
    
    <div class="row g-3">
        {% for field in screening_check_form %}
            {% if field.name == 'B5_oedema' %}
                <div class="mb-3 fade d-none" id="B5Wrapper">
                    {{ field.label_tag }} {{ field }}
                </div>
            {% elif field.name == 'E4_menarke' %}
            <div class="mb-3 fade d-none" id="E4Wrapper">

                    {{ field.label_tag }} {{ field }}
                </div>
            {% elif field.name == 'E5_regularity_period_difficulties' %}
                <div class="mb-3 fade d-none" id="E5Wrapper">
                    {{ field.label_tag }} {{ field }}
                </div>
            {% elif field.name == 'E8_menstrual_pain' %}
                <div class="mb-3 fade d-none" id="E8Wrapper">
                    {{ field.label_tag }} {{ field }}
                </div>
            {% else %}
                <div class="mb-3">
                    {{ field.label_tag }} {{ field }}
                </div>
            {% endif %}
        {% endfor %}
    </div>

    <div class="mt-4">
        <button type="submit" class="btn btn-primary">Save Screening</button>
    </div>
</form>

<!-- =========================
     JS: Dynamic Visibility & Age Auto-fill
========================= -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const studentSelect = document.getElementById('studentSelect');
        const screenDateInput = document.getElementById('id_screen_date');
        const ageField = document.getElementById('id_age_screening');
    
        const B5Wrapper = document.getElementById('B5Wrapper');
        const E4Wrapper = document.getElementById('E4Wrapper');
        const E5Wrapper = document.getElementById('E5Wrapper');
        const E8Wrapper = document.getElementById('E8Wrapper');
        const muacWrapper = document.getElementById('muacWrapper');
        const muacField = document.getElementById('id_muac');
    
        function getTotalMonths(dob, screenDate) {
            if (!dob || !screenDate) return null;
            const birth = new Date(dob);
            const screen = new Date(screenDate);
            let months = (screen.getFullYear() - birth.getFullYear()) * 12 + (screen.getMonth() - birth.getMonth());
            if (screen.getDate() < birth.getDate()) months -= 1;
            return months >= 0 ? Math.floor(months) : null;
        }
    
        function formatAge(totalMonths) {
            if (totalMonths === null) return '';
            const years = Math.floor(totalMonths / 12);
            const months = totalMonths % 12;
            return `${years}y ${months}m (${totalMonths} months)`;
        }
    
        function showElement(el) { if (el) el.classList.remove('d-none'); }
        function hideElement(el) { if (el) el.classList.add('d-none'); }
    
        function updateVisibility() {
            const selectedOption = studentSelect.selectedOptions[0];
            if (!selectedOption) return;
    
            const dob = selectedOption.dataset.dob;
            const gender = (selectedOption.dataset.gender || '').toLowerCase();
            const screenDate = screenDateInput?.value;
    
            const totalMonths = getTotalMonths(dob, screenDate);
    
            // Update age
            if (ageField) ageField.value = formatAge(totalMonths);
    
            // Show E4 (and always show E5/E8) if female
            if (gender === 'female' || gender === 'f') {
                showElement(E4Wrapper);
                showElement(E5Wrapper);
                showElement(E8Wrapper);
            } else {
                [E4Wrapper, E5Wrapper, E8Wrapper].forEach(hideElement);
            }
    
            // B5 depends on age 24–72 months
            if (totalMonths !== null && totalMonths >= 24 && totalMonths <= 72) showElement(B5Wrapper);
            else hideElement(B5Wrapper);
    
            // MUAC depends on age 6–60 months
            if (totalMonths !== null && totalMonths >= 6 && totalMonths <= 60) {
                showElement(muacWrapper);
                if (muacField) muacField.disabled = false;
            } else {
                hideElement(muacWrapper);
                if (muacField) muacField.disabled = true;
            }
        }
    
        studentSelect.addEventListener('change', updateVisibility);
        screenDateInput?.addEventListener('input', updateVisibility);
        screenDateInput?.addEventListener('change', updateVisibility);
    
        updateVisibility();
    });
    </script>
                                
{% endblock %}
