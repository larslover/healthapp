{# core/_screening_card.html #}
{% load custom_filters %}

<div class="card mb-3 shadow-sm">

  <!-- HEADER -->
  <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
    <span>{{ screening.screen_date|date:"Y-m-d" }}</span>
    <button type="button"
            class="btn btn-sm btn-light"
            data-bs-toggle="collapse"
            data-bs-target="#screeningBody{{ screening.id }}">
      Hide
    </button>
  </div>

  <!-- BODY -->
  <div id="screeningBody{{ screening.id }}" class="collapse show">
    <div class="card-body">

      {% with age_months=student.date_of_birth|months_at_screening:screening.screen_date %}

      <!-- BASIC MEASUREMENTS -->
      <div class="row mb-2">
        <div class="col-md-2"><strong>Weight:</strong> {{ screening.weight|default:"—" }} kg</div>
        <div class="col-md-2"><strong>Height:</strong> {{ screening.height|default:"—" }} cm</div>
        <div class="col-md-2"><strong>Age:</strong> {{ student.date_of_birth|age_at_screening:screening.screen_date }}</div>

        {% if age_months >= 60 %}
        <div class="col-md-2">
          <strong>BMI:</strong> {{ screening.bmi|default:"—" }}
          {% if screening.bmi_category %}
            <span class="{% if screening.bmi_category|lower == 'normal' %}text-muted{% else %}text-danger{% endif %}">
              ({{ screening.bmi_category }})
            </span>
          {% endif %}
        </div>
        {% endif %}

        {% if 6 <= age_months <= 60 and screening.muac %}
        <div class="col-md-2">
          <strong>MUAC:</strong> {{ screening.muac }} cm
          <span class="{% if screening.muac_category != 'normal' %}text-danger{% else %}text-success{% endif %}">
            ({{ screening.muac_category|default:"—" }})
          </span>
        </div>
        {% endif %}
      </div>

      <!-- WEIGHT FOR HEIGHT -->
      {% if 24 <= age_months <= 60 %}
      <div class="row mb-2">
        <div class="col-md-4">
          <strong>Weight-for-Height:</strong>
          {% if screening.weight and screening.height %}
            {{ screening.weight }} kg / {{ screening.height }} cm
            (<span class="{% if screening.wfh_category != 'Normal' %}text-danger{% else %}text-success{% endif %}">
              {{ screening.wfh_category }}
            </span>)
          {% else %}
            —
          {% endif %}
        </div>
      </div>
      {% endif %}

      <!-- VISION -->
      <div class="row mb-2">
        <div class="col-md-3"><strong>Vision (Left):</strong> {{ screening.vision_left|default:"—" }}</div>
        <div class="col-md-3"><strong>Vision (Right):</strong> {{ screening.vision_right|default:"—" }}</div>
        <div class="col-md-3">
          <strong>Vision Problem:</strong>
          {% if screening.vision_problem == "Yes" %}
            <span class="text-danger">Yes</span>
          {% elif screening.vision_problem == "No" %}
            <span class="text-muted">No</span>
          {% else %}
            <span class="text-secondary">N/A</span>
          {% endif %}
        </div>
      </div>

      <!-- PREVENTIVE CARE -->
      {% if screening.checklist_dict.vaccination or screening.checklist_dict.deworming %}
      <div class="row mt-3 mb-2">
        <div class="col-md-3">
          <strong>Vaccination:</strong>
          <span class="{% if screening.checklist_dict.vaccination|lower in 'no unknown' %}text-danger{% endif %}">
            {{ screening.checklist_dict.vaccination|default:"—" }}
          </span>
        </div>
        <div class="col-md-3">
          <strong>Deworming:</strong>
          <span class="{% if screening.checklist_dict.deworming|lower in 'no unknown' %}text-danger{% endif %}">
            {{ screening.checklist_dict.deworming|default:"—" }}
          </span>
        </div>
      </div>
      {% endif %}

      <!-- DOCTOR REMARKS -->
      {% if screening.checklist_dict.E9_remarks %}
      <div class="mt-4">
        <h6 class="fw-bold text-danger">Doctor’s Remarks:</h6>
        <p class="text-danger mb-0">{{ screening.checklist_dict.E9_remarks }}</p>
      </div>
      {% endif %}

      <!-- CHECKLIST -->
      {% if screening.checklist_dict %}
      <div class="mt-3">
        <h6 class="fw-bold">Checklist:</h6>

        {% if screening.checklist_dict|any_true %}
          <div class="mt-2">
            {% for group_name, fields in checklist_groups.items %}
              {% if group_name != "Preventive Care" and group_name != "Other Observations" %}
                <div class="row mb-2">
                  {% for field_name in fields %}
                    {% if screening.checklist_dict|dict_get:field_name %}
                      <div class="col-md-3">
                        <strong>{{ field_name|capfirst }}:</strong> ✅
                      </div>
                    {% endif %}
                  {% endfor %}
                </div>
              {% endif %}
            {% endfor %}
          </div>
        {% else %}
          <p class="text-muted fst-italic mb-0">N/A</p>
        {% endif %}
      </div>
      {% endif %}

      {% endwith %}
    </div>
  </div>
</div>
