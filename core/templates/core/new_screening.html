{% extends "core/base.html" %}
{% block title %}Add Screening{% endblock %}

{% block content %}
<div class="container my-4">
  <div style="color:red;">
    DEBUG selected_student: {{ selected_student_id }}
  </div>
  <!-- Page Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold">New Screening</h2>
    <a href="{% url 'student_create' %}" class="btn btn-success">Add Student</a>
  </div>

  <!-- Filter Form -->
  <form method="get" class="row g-3 mb-4">
    <div class="col-md-4">
      <label class="form-label">Student Name</label>
      <input type="text" name="student_name" class="form-control"
             value="{{ student_name_query|default:'' }}">
    </div>

    <div class="col-md-4">
      <label class="form-label">School</label>
      <select name="school" class="form-select">
        <option value="">-- All Schools --</option>
        {% for school in schools %}
          <option value="{{ school.id }}"
            {% if selected_school_id == school.id %}selected{% endif %}>
            {{ school.name }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-4 d-flex align-items-end">
      <button type="submit" class="btn btn-primary">Filter</button>
    </div>
  </form>

  <!-- Students Table -->
  {% if students_page %}
  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-secondary text-white fw-bold">Students</div>
    <div class="card-body p-0">
      <table class="table table-striped mb-0">
        <thead>
          <tr>
            <th>Name</th>
            <th>School</th>
            <th>Gender</th>
            <th>DOB</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for s in students_page %}
          <tr>
            <td>{{ s.name }}</td>
            <td>{{ s.school.name|default:"—" }}</td>
            <td>{{ s.gender|default:"—" }}</td>
            <td>{{ s.date_of_birth|date:"Y-m-d" }}</td>
            <td>
              <a 
              href="?school={{ selected_school_id }}&student_name={{ student_name_query }}&selected_student={{ s.id }}"
              class="btn btn-sm btn-primary"
            >
              Select
            </a>
            
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="5" class="text-center text-muted">No students found.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Pagination -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>Page {{ students_page.number }} of {{ students_page.paginator.num_pages }}</div>
    <div>
      <nav>
        <ul class="pagination mb-0">

          <!-- Previous -->
          {% if students_page.has_previous %}
          <li class="page-item">
            <a class="page-link"
               href="?page={{ students_page.previous_page_number }}{% if selected_school_id %}&school={{ selected_school_id }}{% endif %}{% if student_name_query %}&student_name={{ student_name_query }}{% endif %}">
              Previous
            </a>
          </li>
          {% else %}
          <li class="page-item disabled"><span class="page-link">Previous</span></li>
          {% endif %}

          <!-- Next -->
          {% if students_page.has_next %}
          <li class="page-item">
            <a class="page-link"
               href="?page={{ students_page.next_page_number }}{% if selected_school_id %}&school={{ selected_school_id }}{% endif %}{% if student_name_query %}&student_name={{ student_name_query }}{% endif %}">
              Next
            </a>
          </li>
          {% else %}
          <li class="page-item disabled"><span class="page-link">Next</span></li>
          {% endif %}

        </ul>
      </nav>
    </div>
  </div>
  {% endif %}



  <!-- Selected Student Info Card -->
  <div id="studentInfoCardWrapper">
    {% if student %}
      {% include "core/_student_card.html" %}
    {% else %}
      <div class="card mb-4 shadow-sm">
        <div class="card-body text-muted">Select a student to view info and add screening</div>
      </div>
    {% endif %}
  </div>

  <!-- Screening Form -->
  {% if student %}
  <form method="POST" class="needs-validation" novalidate>
    {% csrf_token %}
    
    <!-- Screening Basic Info -->
    <div class="row g-3 mb-4">
      <div class="col-md-3">{{ screening_form.screen_date.label_tag }} {{ screening_form.screen_date }}</div>
      <div class="col-md-3">{{ screening_form.class_section.label_tag }} {{ screening_form.class_section }}</div>
      <div class="col-md-3">{{ screening_form.school.label_tag }} {{ screening_form.school }}</div>
      <div class="col-md-3">{{ screening_form.age_screening.label_tag }} {{ screening_form.age_screening }}</div>
      <div class="col-md-3">{{ screening_form.weight.label_tag }} {{ screening_form.weight }}</div>
      <div class="col-md-3">{{ screening_form.height.label_tag }} {{ screening_form.height }}</div>
    </div>

    <!-- Previous Screenings -->
    <div id="screeningsSummaryCard" class="card mb-4 shadow-sm {% if not screenings %}d-none{% endif %}">
      <div class="card-header bg-info text-white fw-bold">Previous Screenings</div>
      <div class="card-body" id="screeningsSummaryContent">
        {% if screenings %}
          {% for screening in screenings %}
            {% include "core/_screening_card.html" with screening=screening student=student %}
          {% endfor %}
        {% else %}
          <p class="text-muted">No screenings available.</p>
        {% endif %}
      </div>
    </div>

    <!-- Growth Chart -->
    <div id="studentGrowthChartCard" class="card mb-4 shadow-sm d-none">
      <div class="card-header bg-success text-white fw-bold">Growth Chart</div>
      <div class="card-body">
        <div id="studentGrowthChart" style="width:100%; height:400px;"></div>
      </div>
    </div>

    <!-- Screening Checklist -->
    <hr class="my-4">
    <h5 class="fw-semibold mb-3">Screening Checklist</h5>
    <div class="mb-3" id="muacWrapper">
      {{ screening_form.muac.label_tag }} {{ screening_form.muac }}
    </div>
    <div class="row g-3">
      {% for field in screening_check_form %}
        {% if field.name == 'B5_oedema' %}
          <div class="mb-3" id="B5Wrapper">{{ field.label_tag }} {{ field }}</div>
        {% elif field.name == 'E4_menarke' %}
          <div class="mb-3 fade d-none" id="E4Wrapper">{{ field.label_tag }} {{ field }}</div>
        {% elif field.name == 'E5_regularity_period_difficulties' %}
          <div class="mb-3 fade d-none" id="E5Wrapper">{{ field.label_tag }} {{ field }}</div>
        {% elif field.name == 'E8_menstrual_pain' %}
          <div class="mb-3 fade d-none" id="E8Wrapper">{{ field.label_tag }} {{ field }}</div>
        {% else %}
          <div class="mb-3">{{ field.label_tag }} {{ field }}</div>
        {% endif %}
      {% endfor %}
    </div>

    <!-- Submit Button -->
    <div class="mt-4">
      <button type="submit" class="btn btn-primary px-4 py-2 fw-semibold">Save Screening</button>
    </div>
  </form>
  {% endif %}

</div>
<!-- Hidden container to store student info -->
<div id="screeningData"
     data-dob="{% if student %}{{ student.date_of_birth|date:'Y-m-d' }}{% endif %}"
     data-gender="{% if student %}{{ student.gender|lower }}{% endif %}">
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // --------------------
  // Elements
  // --------------------
  const screeningData = document.getElementById('screeningData');
  const screenDateInput = document.getElementById('id_screen_date');
  const weightInput = document.getElementById('id_weight');
  const heightInput = document.getElementById('id_height');
  const ageField = document.getElementById('id_age_screening');
  const indicatorField = document.getElementById('growthIndicator');
  const valueField = document.getElementById('growthValue');
  const categoryField = document.getElementById('growthCategory');

  let currentDob = screeningData.dataset.dob || "";
  let currentGender = screeningData.dataset.gender || "";

  // --------------------
  // Utility functions
  // --------------------
  function getTotalMonths(dob, screenDate) {
      if (!dob || !screenDate) return null;
      const birth = new Date(dob);
      const screen = new Date(screenDate);
      let months = (screen.getFullYear() - birth.getFullYear()) * 12 + (screen.getMonth() - birth.getMonth());
      if (screen.getDate() < birth.getDate()) months -= 1;
      return months >= 0 ? Math.floor(months) : null;
  }

  function formatAge(totalMonths) {
      if (totalMonths === null) return '';
      const years = Math.floor(totalMonths / 12);
      const months = totalMonths % 12;
      return `${years}y ${months}m (${totalMonths} months)`;
  }

  function updateGrowthReference() {
      const weight = parseFloat(weightInput?.value);
      const height = parseFloat(heightInput?.value);
      const screenDate = screenDateInput?.value;

      if (!weight || !height || !currentDob || !currentGender || !screenDate) {
          indicatorField.value = valueField.value = categoryField.value = '';
          return;
      }

      fetch(`/growth-reference/?gender=${currentGender}&weight=${weight}&height=${height}&dob=${currentDob}&screen_date=${screenDate}`)
      .then(res => res.json())
      .then(data => {
          const totalMonths = getTotalMonths(currentDob, screenDate);

          if (totalMonths <= 60 && data.weight_for_height) {
              indicatorField.value = "Weight-for-Height";
              valueField.value = weight;
              categoryField.value = data.weight_for_height;
          } else if (totalMonths > 60 && data.bmi) {
              indicatorField.value = "BMI-for-Age";
              valueField.value = data.bmi;
              categoryField.value = data.bmi_category;
          } else {
              indicatorField.value = valueField.value = categoryField.value = '';
          }
      }).catch(console.error);
  }

  // --------------------
  // Event listeners
  // --------------------
  screenDateInput?.addEventListener('input', () => {
      if (ageField) ageField.value = formatAge(getTotalMonths(currentDob, screenDateInput.value));
      updateGrowthReference();
  });

  weightInput?.addEventListener('input', updateGrowthReference);
  heightInput?.addEventListener('input', updateGrowthReference);

});
</script>

  {% endblock %}