{% extends "core/base.html" %}
{% block title %}Add Screening{% endblock %}

{% block content %}
<div class="container my-4">
  <h2 class="fw-bold mb-4 d-flex justify-content-between align-items-center">
    New Screening
    <a href="{% url 'student_create' %}" class="btn btn-success">Add Student</a>
  </h2>
</div>

  <!-- Last Doctor’s Remarks -->
  <div id="remarksContainer" class="alert alert-danger fw-semibold mb-4" style="display:none;">
    <strong>Last Doctor’s Remarks:</strong><br>
    <span id="remarksText"></span>
  </div>

  <form method="POST" class="needs-validation" novalidate>
    {% csrf_token %}

    <!-- School Selection -->
    <div class="mb-4">
      <label for="schoolSelect" class="form-label fw-semibold">Select School</label>
      <select id="schoolSelect" name="school" class="form-select">

        <option value="">-- All Schools --</option>
        {% for school in schools %}
          <option value="{{ school.id }}">{{ school.name }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Student Selection -->
    <div class="mb-4">
      <label for="studentSelect" class="form-label fw-semibold">Select Existing Student</label>
      <select id="studentSelect" name="student" class="form-select" required>
        <option value="">-- Select a student --</option>
        <option value="{{ school.id }}" {% if school.id|stringformat:"s" == selected_school_id|stringformat:"s" %}selected{% endif %}>
          {{ school.name }}
      </option>
      
        {% for student in students %}
          <option value="{{ student.id }}"
                  data-dob="{{ student.date_of_birth|date:'Y-m-d' }}"
                  data-gender="{{ student.gender|lower }}"
                  data-school="{{ student.school.id }}">
            {{ student.name }}
          </option>
        {% endfor %}
      </select>
    </div>

<!-- Student Info Card -->
<div id="studentInfoCard" class="card mb-4 shadow-sm" style="display:none;">
  <div class="card-header bg-primary text-white fw-bold">Student Information</div>
  <div class="card-body">
    <div class="row mb-2">
      <div class="col-md-4"><strong>Name:</strong> <span id="infoName"></span></div>
      <div class="col-md-4"><strong>Gender:</strong> <span id="infoGender"></span></div>
      <div class="col-md-4"><strong>Age:</strong> <span id="infoAge"></span></div>
    </div>
    <div class="row mb-2">
      <div class="col-md-6"><strong>School:</strong> <span id="infoSchool"></span></div>
      <div class="col-md-6"><strong>DOB:</strong> <span id="infoDob"></span></div>
    </div>
    <div><strong>Known Earlier Disease:</strong> 
      <span id="infoDisease" class="text-danger">—</span>
    </div>
  </div>
</div>
<!-- Previous Screenings Summary -->
<div id="screeningsSummaryCard" class="card mb-4 shadow-sm d-none">
  <div class="card-header bg-info text-white fw-bold">Last Screening</div>
  <div class="card-body" id="screeningsSummaryContent"></div>
</div>



    <!-- Screening Details -->
    <hr class="my-4">
    <h5 class="fw-semibold mb-3">Screening Details</h5>
    <div class="row g-3">
      <div class="col-md-3">{{ screening_form.screen_date.label_tag }} {{ screening_form.screen_date }}</div>
      <div class="col-md-3">{{ screening_form.class_section.label_tag }} {{ screening_form.class_section }}</div>
      <div class="col-md-3">{{ screening_form.school.label_tag }} {{ screening_form.school }}</div>
      <div class="col-md-3">{{ screening_form.age_screening.label_tag }} {{ screening_form.age_screening }}</div>
      <div class="col-md-3">{{ screening_form.weight.label_tag }} {{ screening_form.weight }}</div>
      <div class="col-md-3">{{ screening_form.height.label_tag }} {{ screening_form.height }}</div>
      <div class="col-md-2">{{ screening_form.vision_both.label_tag }} {{ screening_form.vision_both }}</div>
      <div class="col-md-2">{{ screening_form.vision_left.label_tag }} {{ screening_form.vision_left }}</div>
      <div class="col-md-2">{{ screening_form.vision_right.label_tag }} {{ screening_form.vision_right }}</div>
    </div>

    <!-- Growth Reference -->
    <hr class="my-4">
    <h5 class="fw-semibold mb-3">Growth Reference (for doctor’s reference only)</h5>
    <div class="row g-3 align-items-center mb-3">
      <div class="col-md-4">
        <label class="form-label fw-semibold">Indicator</label>
        <input type="text" id="growthIndicator" class="form-control" readonly>
      </div>
      <div class="col-md-4">
        <label class="form-label fw-semibold">Calculated Value</label>
        <input type="text" id="growthValue" class="form-control" readonly>
      </div>
      <div class="col-md-4">
        <label class="form-label fw-semibold">Category</label>
        <input type="text" id="growthCategory" class="form-control" readonly>
      </div>
    </div>

    <!-- Screening Checklist -->
    <hr class="my-4">
    <h5 class="fw-semibold mb-3">Screening Checklist</h5>
    <div class="mb-3" id="muacWrapper">
      {{ screening_form.muac.label_tag }} {{ screening_form.muac }}
    </div>
    <div class="row g-3">
      {% for field in screening_check_form %}
        {% if field.name == 'B5_oedema' %}
          <div class="mb-3" id="B5Wrapper">{{ field.label_tag }} {{ field }}</div>
        {% elif field.name == 'E4_menarke' %}
          <div class="mb-3 fade d-none" id="E4Wrapper">{{ field.label_tag }} {{ field }}</div>
        {% elif field.name == 'E5_regularity_period_difficulties' %}
          <div class="mb-3 fade d-none" id="E5Wrapper">{{ field.label_tag }} {{ field }}</div>
        {% elif field.name == 'E8_menstrual_pain' %}
          <div class="mb-3 fade d-none" id="E8Wrapper">{{ field.label_tag }} {{ field }}</div>
        {% else %}
          <div class="mb-3">{{ field.label_tag }} {{ field }}</div>
        {% endif %}
      {% endfor %}
    </div>

    <!-- Submit Button -->
    <div class="mt-4">
      <button type="submit" class="btn btn-primary px-4 py-2 fw-semibold">Save Screening</button>
    </div>
  </form>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
      const schoolSelect = document.getElementById('schoolSelect');
      const studentSelect = document.getElementById('studentSelect');
      const remarksContainer = document.getElementById('remarksContainer');
      const remarksText = document.getElementById('remarksText');
      const screenDateInput = document.getElementById('id_screen_date');
      const ageField = document.getElementById('id_age_screening');
      const muacField = document.getElementById('id_muac');
      const weightInput = document.getElementById('id_weight');
      const heightInput = document.getElementById('id_height');
      const indicatorField = document.getElementById('growthIndicator');
      const valueField = document.getElementById('growthValue');
      const categoryField = document.getElementById('growthCategory');
  
      const B5Wrapper = document.getElementById('B5Wrapper');
      const E4Wrapper = document.getElementById('E4Wrapper');
      const E5Wrapper = document.getElementById('E5Wrapper');
      const E8Wrapper = document.getElementById('E8Wrapper');
      const muacWrapper = document.getElementById('muacWrapper');
  
      let currentDob = null;
      let currentGender = null;
      let currentMonths = null;
  
      // ---------------------------
      // Utility Functions
      // ---------------------------
      const showElement = el => el && el.classList.remove('d-none') && el.classList.contains('fade') && el.classList.add('show');
      const hideElement = el => el && (el.classList.add('d-none'), el.classList.remove('show'));
  
      function getTotalMonths(dob, screenDate) {
          if (!dob || !screenDate) return null;
          const birth = new Date(dob);
          const screen = new Date(screenDate);
          let months = (screen.getFullYear() - birth.getFullYear()) * 12 + (screen.getMonth() - birth.getMonth());
          if (screen.getDate() < birth.getDate()) months -= 1;
          return months >= 0 ? Math.floor(months) : null;
      }
  
      function formatAge(totalMonths) {
          if (totalMonths === null) return '';
          const years = Math.floor(totalMonths / 12);
          const months = totalMonths % 12;
          return `${years}y ${months}m (${totalMonths} months)`;
      }
  
      function debounce(fn, delay=300){
          let timer;
          return function(...args){
              clearTimeout(timer);
              timer = setTimeout(() => fn.apply(this, args), delay);
          }
      }
  
      // ---------------------------
      // Fetch previous screenings
      // ---------------------------
      async function fetchPreviousScreenings(studentId) {
          const summaryCard = document.getElementById('screeningsSummaryCard');
          const summaryContent = document.getElementById('screeningsSummaryContent');
  
          if (!studentId) {
              summaryCard.classList.add('d-none');
              summaryContent.innerHTML = '';
              return;
          }
  
          try {
              const res = await fetch(`/get_previous_screenings/?student_id=${studentId}`);
              const data = await res.json();
              summaryContent.innerHTML = data.html && data.html.trim() !== '' ? data.html : '<p class="text-muted">No previous screenings found.</p>';
              summaryCard.classList.remove('d-none');
          } catch (err) {
              console.error('Error fetching previous screenings:', err);
              summaryContent.innerHTML = '<p class="text-danger">Failed to load previous screenings.</p>';
              summaryCard.classList.remove('d-none');
          }
      }
  
      // ---------------------------
      // Fetch last remarks
      // ---------------------------
      async function fetchLastRemarks(studentId) {
          if (!studentId) {
              remarksContainer.style.display = 'none';
              remarksText.textContent = '';
              return;
          }
  
          try {
              const res = await fetch(`/get_last_remarks/?student_id=${studentId}`);
              const data = await res.json();
              if (data.remarks) {
                  remarksText.textContent = data.remarks;
                  remarksContainer.style.display = 'block';
              } else {
                  remarksContainer.style.display = 'none';
              }
          } catch (err) {
              console.error('Error fetching remarks:', err);
              remarksContainer.style.display = 'none';
          }
      }
  
      // ---------------------------
      // Load students dynamically
      // ---------------------------
      async function loadStudents(schoolId) {
          studentSelect.innerHTML = '<option value="">-- Select a student --</option>';
          if (!schoolId) return;
  
          try {
            const res = await fetch('/get_school_students/?school=' + encodeURIComponent(schoolId));

              const data = await res.json();
              data.forEach(s => {
                  const opt = document.createElement('option');
                  opt.value = s.id;
                  opt.dataset.dob = s.date_of_birth;
                  opt.dataset.gender = s.gender;
                  opt.dataset.school = s.school_id;
                  opt.textContent = s.name;
                  studentSelect.appendChild(opt);
              });
          } catch (err) {
              console.error('Error fetching students:', err);
          }
      }
  
      // ---------------------------
      // Update growth reference
      // ---------------------------
      const updateGrowthReference = debounce(async function() {
          const weight = parseFloat(weightInput.value);
          const height = parseFloat(heightInput.value);
          const screenDate = screenDateInput.value;
          if (!weight || !height || !currentDob || !currentGender || !screenDate) {
              indicatorField.value = valueField.value = categoryField.value = '';
              return;
          }
  
          try {
              const url = `/growth-reference/?gender=${currentGender}&weight=${weight}&height=${height}&dob=${currentDob}&screen_date=${screenDate}`;
              const res = await fetch(url);
              if (!res.ok) return;
              const data = await res.json();
  
              if (currentMonths <= 60 && data.weight_for_height) {
                  indicatorField.value = "Weight-for-Height";
                  valueField.value = weight;
                  categoryField.value = data.weight_for_height;
              } else if (currentMonths > 60 && data.bmi) {
                  indicatorField.value = "BMI-for-Age";
                  valueField.value = data.bmi;
                  categoryField.value = data.bmi_category;
              } else {
                  indicatorField.value = valueField.value = categoryField.value = '';
              }
          } catch (err) {
              console.error('Error fetching growth data:', err);
          }
      }, 400);
  
      // ---------------------------
      // Update visibility and age
      // ---------------------------
      function updateVisibility() {
          const selectedOption = studentSelect.selectedOptions[0];
          if (!selectedOption || !selectedOption.dataset.dob || !selectedOption.dataset.gender) {
              [E4Wrapper, E5Wrapper, E8Wrapper, B5Wrapper].forEach(hideElement);
              hideElement(muacWrapper);
              if (muacField) muacField.disabled = true;
              if (ageField) ageField.value = '';
              indicatorField.value = valueField.value = categoryField.value = '';
              return;
          }
  
          currentDob = selectedOption.dataset.dob;
          currentGender = selectedOption.dataset.gender.toLowerCase();
          currentMonths = getTotalMonths(currentDob, screenDateInput.value);
          if (ageField) ageField.value = formatAge(currentMonths);
  
          // Female-specific fields
          if (currentGender === 'female' || currentGender === 'f') {
              showElement(E4Wrapper);
              const E4Checkbox = document.getElementById('id_E4_menarke');
              if (E4Checkbox) {
                  if (E4Checkbox.checked) { showElement(E5Wrapper); showElement(E8Wrapper); }
                  E4Checkbox.onchange = function() {
                      if (this.checked) { showElement(E5Wrapper); showElement(E8Wrapper); }
                      else { hideElement(E5Wrapper); hideElement(E8Wrapper); }
                  }
              }
          } else {
              [E4Wrapper, E5Wrapper, E8Wrapper].forEach(hideElement);
          }
  
          // Age-based fields
          if (currentMonths >= 24 && currentMonths <= 72) showElement(B5Wrapper); else hideElement(B5Wrapper);
          if (currentMonths >= 6 && currentMonths <= 60) { showElement(muacWrapper); if (muacField) muacField.disabled = false; }
          else { hideElement(muacWrapper); if (muacField) muacField.disabled = true; }
  
          updateGrowthReference();
      }
  
      // ---------------------------
      // Event listeners
      // ---------------------------
      schoolSelect.addEventListener('change', function() {
          loadStudents(this.value);
          remarksContainer.style.display = 'none';
          remarksText.textContent = '';
          studentSelect.value = '';
      });
  
      studentSelect.addEventListener('change', function() {
          updateVisibility();
          const studentId = this.value;
          fetchPreviousScreenings(studentId);
          fetchLastRemarks(studentId);
      });
  
      screenDateInput?.addEventListener('input', updateVisibility);
      screenDateInput?.addEventListener('change', updateVisibility);
      weightInput?.addEventListener('input', updateGrowthReference);
      heightInput?.addEventListener('input', updateGrowthReference);
  });
  </script>
  
<style>
.form-check-input{width:1.4em;height:1.4em;border:2px solid #000!important;cursor:pointer;}
.form-check-input:checked{background-color:#198754!important;border-color:#145c32!important;}
.form-check-label{font-weight:500;margin-left:0.5em;color:#222;}
.form-check{padding:0.3em 0;}
</style>

{% endblock %}
