{% extends "core/base.html" %}
{% block title %}Add Screening{% endblock %}
{% include "core/_student_select.html" %}

{% block content %}
<div class="container my-4">
  <h2 class="fw-bold mb-4 d-flex justify-content-between align-items-center">
    New Screening
    <a href="{% url 'student_create' %}" class="btn btn-success">Add Student</a>
  </h2>
</div>

  <!-- Last Doctor’s Remarks -->
  <div id="remarksContainer" class="alert alert-danger fw-semibold mb-4" style="display:none;">
    <strong>Last Doctor’s Remarks:</strong><br>
    <span id="remarksText"></span>
  </div>

  <form method="POST" class="needs-validation" novalidate>
    {% csrf_token %}

    <!-- School Selection -->
    <div class="mb-4">
      <label for="schoolSelect" class="form-label fw-semibold">Select School</label>
      <select id="schoolSelect" class="form-select">
        <option value="">-- All Schools --</option>
        {% for school in schools %}
          <option value="{{ school.id }}">{{ school.name }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Student Selection -->
    <div class="mb-4">
      <label for="studentSelect" class="form-label fw-semibold">Select Existing Student</label>
      <select id="studentSelect" name="student" class="form-select" required>
        <option value="">-- Select a student --</option>
        {% for student in students %}
          <option value="{{ student.id }}"
                  data-dob="{{ student.date_of_birth|date:'Y-m-d' }}"
                  data-gender="{{ student.gender|lower }}"
                  data-school="{{ student.school.id }}">
            {{ student.name }}
          </option>
        {% endfor %}
      </select>
    </div>
    <div id="studentInfoCardWrapper">
      {% if student %}
        {% include "core/_student_card.html" %}
      {% else %}
        <div class="card mb-4 shadow-sm">
          <div class="card-body text-muted">Select a student to view info</div>
        </div>
      {% endif %}
    </div>
    <!-- Previous Screenings Summary -->
<div id="screeningsSummaryCard" class="card mb-4 shadow-sm {% if not screenings %}d-none{% endif %}">
  <div class="card-header bg-info text-white fw-bold">Previous Screenings</div>
  <div class="card-body" id="screeningsSummaryContent">
    {% if screenings %}
      {% for screening in screenings %}
        {% include "core/_screening_card.html" with screening=screening student=student %}
      {% endfor %}
    {% else %}
      <p class="text-muted">No screenings available.</p>
    {% endif %}
  </div>
</div>

   <!-- Growth Chart -->
<div id="studentGrowthChartCard" class="card mb-4 shadow-sm d-none">
  <div class="card-header bg-success text-white fw-bold">Growth Chart</div>
  <div class="card-body">
    <div id="studentGrowthChart" style="width:100%; height:400px;"></div>
  </div>
</div>

    

    <!-- Screening Details -->
    <hr class="my-4">
    <h5 class="fw-semibold mb-3">Screening Details</h5>
    <div class="row g-3">
      <div class="col-md-3">{{ screening_form.screen_date.label_tag }} {{ screening_form.screen_date }}</div>
      <div class="col-md-3">{{ screening_form.class_section.label_tag }} {{ screening_form.class_section }}</div>
      <div class="col-md-3">{{ screening_form.school.label_tag }} {{ screening_form.school }}</div>
      <div class="col-md-3">{{ screening_form.age_screening.label_tag }} {{ screening_form.age_screening }}</div>
      <div class="col-md-3">{{ screening_form.weight.label_tag }} {{ screening_form.weight }}</div>
      <div class="col-md-3">{{ screening_form.height.label_tag }} {{ screening_form.height }}</div>
      <div class="col-md-2">{{ screening_form.vision_both.label_tag }} {{ screening_form.vision_both }}</div>
      <div class="col-md-2">{{ screening_form.vision_left.label_tag }} {{ screening_form.vision_left }}</div>
      <div class="col-md-2">{{ screening_form.vision_right.label_tag }} {{ screening_form.vision_right }}</div>
    </div>

    <!-- Growth Reference -->
    <hr class="my-4">
    <h5 class="fw-semibold mb-3">Growth Reference (for doctor’s reference only)</h5>
    <div class="row g-3 align-items-center mb-3">
      <div class="col-md-4">
        <label class="form-label fw-semibold">Indicator</label>
        <input type="text" id="growthIndicator" class="form-control" readonly>
      </div>
      <div class="col-md-4">
        <label class="form-label fw-semibold">Calculated Value</label>
        <input type="text" id="growthValue" class="form-control" readonly>
      </div>
      <div class="col-md-4">
        <label class="form-label fw-semibold">Category</label>
        <input type="text" id="growthCategory" class="form-control" readonly>
      </div>
    </div>

    <!-- Screening Checklist -->
    <hr class="my-4">
    <h5 class="fw-semibold mb-3">Screening Checklist</h5>
    <div class="mb-3" id="muacWrapper">
      {{ screening_form.muac.label_tag }} {{ screening_form.muac }}
    </div>
    <div class="row g-3">
      {% for field in screening_check_form %}
        {% if field.name == 'B5_oedema' %}
          <div class="mb-3" id="B5Wrapper">{{ field.label_tag }} {{ field }}</div>
        {% elif field.name == 'E4_menarke' %}
          <div class="mb-3 fade d-none" id="E4Wrapper">{{ field.label_tag }} {{ field }}</div>
        {% elif field.name == 'E5_regularity_period_difficulties' %}
          <div class="mb-3 fade d-none" id="E5Wrapper">{{ field.label_tag }} {{ field }}</div>
        {% elif field.name == 'E8_menstrual_pain' %}
          <div class="mb-3 fade d-none" id="E8Wrapper">{{ field.label_tag }} {{ field }}</div>
        {% else %}
          <div class="mb-3">{{ field.label_tag }} {{ field }}</div>
        {% endif %}
      {% endfor %}
    </div>

    <!-- Submit Button -->
    <div class="mt-4">
      <button type="submit" class="btn btn-primary px-4 py-2 fw-semibold">Save Screening</button>
    </div>
  </form>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
      // --------------------
      // Elements
      // --------------------
      const schoolSelect = document.getElementById('schoolSelect');
      const studentSelect = document.getElementById('studentSelect');
      const remarksContainer = document.getElementById('remarksContainer');
      const remarksText = document.getElementById('remarksText');
      const screenDateInput = document.getElementById('id_screen_date');
      const ageField = document.getElementById('id_age_screening');
      const weightInput = document.getElementById('id_weight');
      const heightInput = document.getElementById('id_height');
      const indicatorField = document.getElementById('growthIndicator');
      const valueField = document.getElementById('growthValue');
      const categoryField = document.getElementById('growthCategory');
  
      const B5Wrapper = document.getElementById('B5Wrapper');
      const E4Wrapper = document.getElementById('E4Wrapper');
      const E5Wrapper = document.getElementById('E5Wrapper');
      const E8Wrapper = document.getElementById('E8Wrapper');
      const muacWrapper = document.getElementById('muacWrapper');
      const muacField = document.getElementById('id_muac');
  
      const studentInfoCardWrapper = document.getElementById('studentInfoCardWrapper');
      const screeningsSummaryCard = document.getElementById('screeningsSummaryCard');
      const screeningsSummaryContent = document.getElementById('screeningsSummaryContent');
      const chartCard = document.getElementById('studentGrowthChartCard');
      const chartDiv = document.getElementById('studentGrowthChart');
  
      let currentDob = null;
      let currentGender = null;
      let currentMonths = null;
  


      
      // --------------------
      // Utility functions
      // --------------------
      function showElement(el) { if(el){el.classList.remove('d-none'); if(el.classList.contains('fade')) el.classList.add('show');} }
      function hideElement(el) { if(el){el.classList.add('d-none'); el.classList.remove('show');} }
  
      function getTotalMonths(dob, screenDate) {
          if (!dob || !screenDate) return null;
          const birth = new Date(dob);
          const screen = new Date(screenDate);
          let months = (screen.getFullYear() - birth.getFullYear()) * 12 + (screen.getMonth() - birth.getMonth());
          if (screen.getDate() < birth.getDate()) months -= 1;
          return months >= 0 ? Math.floor(months) : null;
      }
  
      function formatAge(totalMonths) {
          if (totalMonths === null) return '';
          const years = Math.floor(totalMonths / 12);
          const months = totalMonths % 12;
          return `${years}y ${months}m (${totalMonths} months)`;
      }
  
      // --------------------
      // Fetch previous screenings
      // --------------------
      async function fetchPreviousScreenings(studentId) {
          if (!studentId) {
              screeningsSummaryCard.classList.add('d-none');
              screeningsSummaryContent.innerHTML = '';
              return;
          }
          try {
              const res = await fetch(`/get_previous_screenings/?student_id=${studentId}`);
              const data = await res.json();
              screeningsSummaryContent.innerHTML = data.html?.trim() || '<p class="text-muted">No previous screenings found.</p>';
              screeningsSummaryCard.classList.remove('d-none');
          } catch(err) {
              console.error('Error fetching previous screenings:', err);
              screeningsSummaryContent.innerHTML = '<p class="text-danger">Failed to load previous screenings.</p>';
              screeningsSummaryCard.classList.remove('d-none');
          }
      }
  
      // --------------------
      // Fetch growth chart
      // --------------------
      async function fetchStudentGrowthChart(studentId) {
    const chartCard = document.getElementById("studentGrowthChartCard");
    const chartDiv = document.getElementById("studentGrowthChart");

    if (!studentId) {
        chartCard.classList.add("d-none");
        chartDiv.innerHTML = '';
        return;
    }

    try {
        const res = await fetch(`/get_student_growth_chart_partial/?student_id=${studentId}`);
        const data = await res.json();

        if (!data.labels || data.labels.length === 0) {
            chartDiv.innerHTML = "<p class='text-muted'>No chart data available.</p>";
            chartCard.classList.remove("d-none");
            return;
        }

        chartCard.classList.remove("d-none");

        const labels = data.labels.map(m => `${Math.floor(m/12)}y ${m%12}m`);
        const studentTrace = {
            x: labels,
            y: data.values,
            mode: "lines+markers",
            name: "Student",
            marker: { size: 10, color: "blue" },
            line: { color: "#333", width: 1 }
        };

        Plotly.newPlot(chartDiv, [studentTrace], {
            title: data.chart_mode === "bmi" ? "BMI-for-Age" : "Weight-for-Height",
            xaxis: { title: "Age", gridcolor: "rgba(200,200,200,0.2)" },
            yaxis: { title: data.chart_mode === "bmi" ? "BMI" : "Weight (kg)", gridcolor: "rgba(200,200,200,0.2)" },
            plot_bgcolor: "#f9f9f9",
            paper_bgcolor: "#fff"
        });

    } catch(err) {
        console.error("Error fetching growth chart:", err);
        chartCard.classList.add("d-none");
    }
}


      // --------------------
      // Fetch last doctor's remarks
      // --------------------
      async function fetchLastRemarks(studentId) {
          if (!studentId) {
              remarksContainer.style.display = 'none';
              remarksText.textContent = '';
              return;
          }
          try {
              const res = await fetch(`/get_last_remarks/?student_id=${studentId}`);
              const data = await res.json();
              if (data.remarks) {
                  remarksText.textContent = data.remarks;
                  remarksContainer.style.display = 'block';
              } else {
                  remarksContainer.style.display = 'none';
              }
          } catch(err) {
              console.error('Error fetching remarks:', err);
              remarksContainer.style.display = 'none';
          }
      }
  
      // --------------------
      // Fetch student card
      // --------------------
      async function fetchStudentCard(studentId) {
          if (!studentId) {
              studentInfoCardWrapper.innerHTML = `<div class="card mb-4 shadow-sm"><div class="card-body text-muted">Select a student to view info</div></div>`;
              return;
          }
          try {
              const res = await fetch(`/get_student_card/?student_id=${studentId}`);
              const html = await res.text();
              studentInfoCardWrapper.innerHTML = html;
          } catch(err) {
              console.error('Error loading student card:', err);
          }
      }
  
      // --------------------
      // Update growth reference
      // --------------------
      async function updateGrowthReference() {
          const weight = parseFloat(weightInput?.value);
          const height = parseFloat(heightInput?.value);
          const screenDate = screenDateInput?.value;
          if (!weight || !height || !currentDob || !currentGender || !screenDate) {
              indicatorField.value = valueField.value = categoryField.value = '';
              return;
          }
  
          try {
              const url = `/growth-reference/?gender=${currentGender}&weight=${weight}&height=${height}&dob=${currentDob}&screen_date=${screenDate}`;
              const res = await fetch(url);
              if (!res.ok) return;
              const data = await res.json();
  
              if (currentMonths <= 60 && data.weight_for_height) {
                  indicatorField.value = "Weight-for-Height";
                  valueField.value = weight;
                  categoryField.value = data.weight_for_height;
              } else if (currentMonths > 60 && data.bmi) {
                  indicatorField.value = "BMI-for-Age";
                  valueField.value = data.bmi;
                  categoryField.value = data.bmi_category;
              } else {
                  indicatorField.value = valueField.value = categoryField.value = '';
              }
          } catch(err) {
              console.error('Error fetching growth data:', err);
          }
      }
  
      // --------------------
      // Update visibility of fields
      // --------------------
      function updateVisibility() {
          const selectedOption = studentSelect.selectedOptions[0];
          if (!selectedOption || !selectedOption.dataset.dob || !selectedOption.dataset.gender) {
              [E4Wrapper,E5Wrapper,E8Wrapper,B5Wrapper].forEach(hideElement);
              hideElement(muacWrapper);
              if (muacField) muacField.disabled = true;
              if (ageField) ageField.value = '';
              indicatorField.value = valueField.value = categoryField.value = '';
              return;
          }
  
          const dob = selectedOption.dataset.dob;
          const gender = selectedOption.dataset.gender.trim().toLowerCase();
          const screenDate = screenDateInput?.value;
  
          currentDob = dob;
          currentGender = gender;
          currentMonths = getTotalMonths(dob, screenDate);
  
          if (ageField) ageField.value = formatAge(currentMonths);
  
          if (gender === 'female' || gender === 'f') {
              showElement(E4Wrapper);
              const E4Checkbox = document.getElementById('id_E4_menarke');
              if(E4Checkbox){
                  if(E4Checkbox.checked) { showElement(E5Wrapper); showElement(E8Wrapper); }
                  E4Checkbox.addEventListener('change', function(){
                      if(E4Checkbox.checked){ showElement(E5Wrapper); showElement(E8Wrapper); }
                      else { hideElement(E5Wrapper); hideElement(E8Wrapper); }
                  });
              }
          } else { [E4Wrapper,E5Wrapper,E8Wrapper].forEach(hideElement); }
  
          if (currentMonths >= 24 && currentMonths <= 72) showElement(B5Wrapper); else hideElement(B5Wrapper);
          if (currentMonths >=6 && currentMonths <= 60){ showElement(muacWrapper); if(muacField) muacField.disabled=false; } 
          else { hideElement(muacWrapper); if(muacField) muacField.disabled=true; }
  
          updateGrowthReference();
      }
  
      // --------------------
      // Filter students by school
      // --------------------
      function filterStudentsBySchool() {
    const selectedSchool = schoolSelect.value;

    // Store all options once
    const allOptions = Array.from(studentSelect.options);
    studentSelect.innerHTML = '';

    // Add default placeholder
    const placeholder = document.createElement('option');
    placeholder.value = '';
    placeholder.textContent = '-- Select a student --';
    studentSelect.appendChild(placeholder);

    // Add filtered students
    allOptions.forEach(opt => {
        if (opt.value === '') return; // skip placeholder
        const studentSchool = opt.dataset.school;
        if (!selectedSchool || studentSchool === selectedSchool) {
            studentSelect.appendChild(opt);
        }
    });

    // Reset selection if previous selection hidden
    if (!studentSelect.value) {
        remarksContainer.style.display = 'none';
        remarksText.textContent = '';
    }

    updateVisibility();
}

      // --------------------
      // Student selection change
      // --------------------
      async function onStudentChange() {
          const studentId = studentSelect.value;
  
          await fetchLastRemarks(studentId);
          await fetchStudentCard(studentId);
          await fetchPreviousScreenings(studentId);
          await fetchStudentGrowthChart(studentId);
          updateVisibility();
          updateGrowthReference();
      }
  
      // --------------------
      // Event listeners
      // --------------------
      schoolSelect?.addEventListener('change', filterStudentsBySchool);
      studentSelect?.addEventListener('change', onStudentChange);
      screenDateInput?.addEventListener('input', updateVisibility);
      screenDateInput?.addEventListener('change', updateVisibility);
      weightInput?.addEventListener('input', updateGrowthReference);
      heightInput?.addEventListener('input', updateGrowthReference);
  
      // --------------------
      // Initialize
      // --------------------
      filterStudentsBySchool();
  });
  </script>
  

<style>
.form-check-input{width:1.4em;height:1.4em;border:2px solid #000!important;cursor:pointer;}
.form-check-input:checked{background-color:#198754!important;border-color:#145c32!important;}
.form-check-label{font-weight:500;margin-left:0.5em;color:#222;}
.form-check{padding:0.3em 0;}
</style>

{% endblock %}
