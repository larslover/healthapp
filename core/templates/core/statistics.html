{% extends "core/base.html" %}

{% block title %}Statistics{% endblock %}

{% block content %}
<div class="container my-4">

  <!-- ================= HEADER ================= -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold mb-0">Screening Statistics</h2>
  </div>

  <!-- ================= FILTERS ================= -->
  <form method="get" class="row g-3 mb-4">

    <div class="col-md-2">
      <label class="form-label">Year</label>
      <select name="year" id="year" class="form-select">
        {% for y in years %}
          <option value="{{ y }}" {% if y|stringformat:"s" == year|stringformat:"s" %}selected{% endif %}>{{ y }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-4">
      <label class="form-label">School</label>
      <select name="school" id="school" class="form-select">
        <option value="">All Schools</option>
        {% for school in schools %}
          <option value="{{ school.id }}" {% if school.id|stringformat:"s" == selected_school|stringformat:"s" %}selected{% endif %}>
            {{ school.name }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-3">
      <label class="form-label">Class</label>
      <select name="class" id="class" class="form-select">
        <option value="">All Classes</option>
        {% for value, label in class_choices %}
          <option value="{{ value }}" {% if value == selected_class %}selected{% endif %}>
            {{ label }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-2 d-flex align-items-end">
      <button type="submit" class="btn btn-primary w-100">Apply</button>
    </div>

  </form>

  <!-- ================= ROW 1: Total Screened, Vision, SAM ================= -->
<div class="row g-3 mb-4">

    <div class="col-md-3">
        <div class="card border-primary border-2 shadow-sm text-center h-100 kpi-card" data-type="total">
          <div class="card-body">
            <h6 class="text-muted">Total Screened</h6>
            <h2 class="fw-bold">{{ stats.totals.screenings|default:0 }}</h2>
          </div>
        </div>
      </div>
      
    <!-- Vision Problems -->
    <div class="col-md-3">
      <div class="card border-info border-2 shadow-sm text-center h-100 kpi-card" data-type="vision">
        <div class="card-body">
          <h6 class="text-muted">Vision Problems</h6>
          <h2 class="fw-bold text-danger">{{ stats.vision|length|default:0 }}</h2>
        </div>
      </div>
    </div>
  
    <!-- SAM (MUAC) -->
    <div class="col-md-3">
      <div class="card border-warning border-2 shadow-sm text-center h-100 kpi-card" data-type="muac">
        <div class="card-body">
          <h6 class="text-muted">SAM (MUAC)</h6>
          <h2 class="fw-bold text-danger">{{ stats.muac_total|default:0 }}</h2>
        </div>
      </div>
    </div>
  
  </div>
  
  <!-- ================= ROW 2: Screening Checks (Checklist KPIs) ================= -->
<div class="card border-primary border-2 bg-light mb-4">

    <!-- Header: clickable -->
    <div class="card-header" data-bs-toggle="collapse" data-bs-target="#screeningChecks" style="cursor:pointer;">
      <h5 class="mb-0">Screening Checks</h5>
    </div>
  
    <!-- Collapsible content -->
    <div id="screeningChecks" class="collapse show">
      <div class="card-body">
        <div class="row g-3">
          {% for item in checklist_stats %}
          <div class="col-md-3">
            <div class="card shadow-sm text-center h-100 kpi-card" data-type="{{ item.key }}">
              <div class="card-body">
                <h6 class="text-muted">{{ item.label }}</h6>
                <h2 class="fw-bold {% if item.danger %}text-danger{% endif %}">{{ item.value|default:0 }}</h2>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  
  </div>
  
  <!-- ================= ROW 3: BMI Distribution ================= -->
  <div class="card border-success border-2 bg-light mb-4">
  
    <!-- Header: clickable -->
    <div class="card-header" data-bs-toggle="collapse" data-bs-target="#bmiCards" style="cursor:pointer;">
      <h5 class="mb-0">BMI Distribution</h5>
    </div>
  
    <!-- Collapsible content -->
    <div id="bmiCards" class="collapse show">
      <div class="card-body">
        <div class="row g-3">
          {% if stats.bmi %}
            {% for b in stats.bmi %}
              <div class="col-md-3">
                <div class="card shadow-sm text-center h-100 kpi-card" data-type="bmi_{{ b.bmi_category|slugify }}">
                  <div class="card-body">
                    <h6 class="text-muted">{{ b.bmi_category }}</h6>
                    <h2 class="fw-bold {% if b.danger %}text-danger{% endif %}">{{ b.count|default:0 }}</h2>
                  </div>
                </div>
              </div>
            {% endfor %}
          {% else %}
            <div class="col-12">
              <p class="text-muted mb-0">No BMI data available</p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  
  </div>
  
  <!-- ================= ROW 4: Weight-for-Height ================= -->
  <div class="card border-warning border-2 bg-light mb-4">
  
    <!-- Header: clickable -->
    <div class="card-header" data-bs-toggle="collapse" data-bs-target="#whCards" style="cursor:pointer;">
      <h5 class="mb-0">Weight-for-Height</h5>
    </div>
  
    <!-- Collapsible content -->
    <div id="whCards" class="collapse show">
      <div class="card-body">
        <div class="row g-3">
          {% if stats.weight_height %}
            {% for wh in stats.weight_height %}
              <div class="col-md-3">
                <div class="card shadow-sm text-center h-100 kpi-card" data-type="wh_{{ wh.weight_height|slugify }}">
                  <div class="card-body">
                    <h6 class="text-muted">{{ wh.weight_height|default:"N/A" }}</h6>
                    <h2 class="fw-bold {% if wh.danger %}text-danger{% endif %}">{{ wh.count|default:0 }}</h2>
                  </div>
                </div>
              </div>
            {% endfor %}
          {% else %}
            <div class="col-12">
              <p class="text-muted mb-0">No Weight-for-Height data available</p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  
  </div>
  
  <!-- Student Result Table -->
<div class="card shadow-sm mt-4 d-none" id="results-card">
    <div class="card-body">
      <h5 class="mb-3" id="results-title">Results</h5>
  
      <div class="table-responsive">
        <table class="table table-striped table-hover">
          <thead>
            <tr>
              <th>Name</th>
              <th>School</th>
              <th>Class</th>
          
              <th>Summary</th>
            </tr>
          </thead>
          <tbody id="results-body">
          </tbody>
        </table>
      </div>
    </div>
</div>



</div>
<div id="pagination" class="mt-2 text-center"></div>

<!-- ================= STYLE ================= -->

<style>
.kpi-card {
    cursor: pointer;
    transition: all 0.2s ease-in-out;
}
.kpi-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 6px 18px rgba(0,0,0,0.15);
}
.kpi-card.active {
    border: 2px solid #0d6efd;
}
</style>

<!-- ================= JAVASCRIPT ================= -->
<script>
   let currentPage = 1;
let currentType = null;

document.addEventListener("DOMContentLoaded", function() {
  const resultsCard = document.getElementById("results-card");
  const resultsBody = document.getElementById("results-body");
  const resultsTitle = document.getElementById("results-title");
  const paginationContainer = document.getElementById("pagination");

  function loadStudents(type, page = 1) {
    const school = document.getElementById("school").value;
    const year = document.getElementById("year").value;
    const studentClass = document.getElementById("class").value;

    fetch(`/ajax/stat-students/?type=${type}&school=${school}&year=${year}&student_class=${studentClass}&page=${page}`)
      .then(response => response.json())
      .then(data => {
        resultsBody.innerHTML = "";
        if (!data.students || data.students.length === 0) {
          resultsBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">No students found</td></tr>`;
        } else {
          data.students.forEach(student => {
            resultsBody.innerHTML += `
              <tr>
                <td>${student.name}</td>
                <td>${student.school}</td>
                <td>${student.class}</td>
                <td>
                  <a href="/screening-summary/?selected_student=${student.id}" class="btn btn-sm btn-outline-primary">View</a>
                </td>
              </tr>
            `;
          });
        }

        resultsTitle.textContent = data.title;
        resultsCard.classList.remove("d-none");
        resultsCard.scrollIntoView({ behavior: "smooth" });

        // Pagination UI
        let paginationHtml = '';

        if (data.has_previous) {
          paginationHtml += `<button class="btn btn-sm btn-outline-secondary me-1" id="prevPage">Previous</button>`;
        }

        paginationHtml += `<span class="mx-2">Page ${data.page} of ${data.num_pages}</span>`;

        if (data.has_next) {
          paginationHtml += `<button class="btn btn-sm btn-outline-secondary ms-1" id="nextPage">Next</button>`;
        }

        paginationHtml += `
          <input type="number" min="1" max="${data.num_pages}" id="gotoPage" value="${data.page}" class="form-control d-inline-block ms-2" style="width: 70px;">
          <button class="btn btn-sm btn-primary ms-1" id="gotoBtn">Go</button>
        `;

        paginationContainer.innerHTML = paginationHtml;

        // Button actions
        if (data.has_previous) document.getElementById("prevPage").onclick = () => loadStudents(type, data.page - 1);
        if (data.has_next) document.getElementById("nextPage").onclick = () => loadStudents(type, data.page + 1);
        document.getElementById("gotoBtn").onclick = () => {
          const gotoPage = parseInt(document.getElementById("gotoPage").value);
          if (gotoPage >= 1 && gotoPage <= data.num_pages) {
            loadStudents(type, gotoPage);
          }
        };
      })
      .catch(error => console.error("Error:", error));
  }

  // KPI card click
  document.querySelectorAll(".kpi-card").forEach(card => {
    card.addEventListener("click", function() {
      document.querySelectorAll(".kpi-card").forEach(c => c.classList.remove("active"));
      this.classList.add("active");
      currentType = this.dataset.type;
      currentPage = 1;
      loadStudents(currentType, currentPage);
    });
  });
});

    </script>
        
{% endblock %}
