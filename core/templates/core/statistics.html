{% extends "core/base.html" %}

{% block title %}Statistics{% endblock %}

{% block content %}
<div class="container my-4">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold mb-0">Screening Statistics</h2>
  </div>

  <!-- Filters -->
  <form method="get" class="row g-3 mb-4">
    <!-- Year -->
    <div class="col-md-2">
      <label for="year" class="form-label">Year</label>
      <select name="year" id="year" class="form-select">
        {% for y in years %}
          <option value="{{ y }}" {% if y|stringformat:"s" == year|stringformat:"s" %}selected{% endif %}>{{ y }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- School -->
    <div class="col-md-4">
      <label for="school" class="form-label">School</label>
      <select name="school" id="school" class="form-select">
        <option value="">All Schools</option>
        {% for school in schools %}
          <option value="{{ school.id }}" {% if school.id|stringformat:"s" == selected_school|stringformat:"s" %}selected{% endif %}>{{ school.name }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Class -->
    <div class="col-md-3">
      <label for="class" class="form-label">Class</label>
      <select name="class" id="class" class="form-select">
        <option value="">All Classes</option>
        {% for value, label in class_choices %}
          <option value="{{ value }}" {% if value == selected_class %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Apply button -->
    <div class="col-md-2 d-flex align-items-end">
      <button type="submit" class="btn btn-primary w-100">Apply</button>
    </div>
  </form>

  <!-- KPI Cards -->

  <!-- Row 1: Total Screened -->
  <div class="row g-3 mb-4">
    {% if stats.totals.screenings > 0 %}
    <div class="col-md-3">
      <div class="card shadow-sm text-center h-100">
        <div class="card-body">
          <h6 class="text-muted">Total Screened</h6>
          <h2 class="fw-bold">{{ stats.totals.screenings }}</h2>
        </div>
      </div>
    </div>
    {% endif %}
  </div>

  <!-- Row 2: Screening Results -->
  <div class="row g-3 mb-4">
    <!-- Vision Issues -->
    {% if stats.vision|length > 0 %}
    <div class="col-md-3">
      <div class="card shadow-sm text-center h-100">
        <div class="card-body">
          <h6 class="text-muted">Vision Issues</h6>
          <h2 class="fw-bold">{{ stats.vision|length }}</h2>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- SAM (MUAC) -->
    {% if stats.muac_total > 0 %}
    <div class="col-md-3">
      <div class="card shadow-sm text-center h-100">
        <div class="card-body">
          <h6 class="text-muted">SAM (MUAC)</h6>
          <h2 class="fw-bold text-danger">{{ stats.muac_total }}</h2>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- ScreeningCheck KPIs -->
    {% for item in checklist_stats %}
      {% if item.value > 0 %}
      <div class="col-md-3">
        <div class="card shadow-sm text-center h-100">
          <div class="card-body">
            <h6 class="text-muted">{{ item.label }}</h6>
            <h2 class="fw-bold {% if item.danger %}text-danger{% endif %}">{{ item.value }}</h2>
          </div>
        </div>
      </div>
      {% endif %}
    {% endfor %}
  </div>

  <!-- Row 3: BMI & Weight-for-Height -->
  <div class="row g-3 mb-4">
    <!-- BMI Distribution -->
    {% if stats.bmi|length > 0 %}
    <div class="col-md-3">
      <div class="card shadow-sm text-center h-100">
        <div class="card-body">
          <h6 class="text-muted">BMI Distribution</h6>
          <ul class="list-unstyled mb-0">
            {% for b in stats.bmi %}
              <li>{{ b.bmi_category }}: {{ b.count }}</li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Weight-for-Height -->
    {% if stats.weight_height|length > 0 %}
    <div class="col-md-3">
      <div class="card shadow-sm text-center h-100">
        <div class="card-body">
          <h6 class="text-muted">Weight-for-Height</h6>
          <ul class="list-unstyled mb-0">
            {% for wh in stats.weight_height %}
              <li>{{ wh.weight_height|default:"N/A" }}: {{ wh.count }}</li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
    {% endif %}
  </div>

</div>

<!-- AJAX to dynamically update class dropdown based on school/year -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    const schoolSelect = document.getElementById("school");
    const classSelect = document.getElementById("class");
    const yearSelect = document.getElementById("year");

    function updateClasses() {
        const schoolId = schoolSelect.value;
        const year = yearSelect.value;

        fetch(`/ajax/get-classes/?school=${schoolId}&year=${year}`)
            .then(response => response.json())
            .then(data => {
                const selected = classSelect.value;
                classSelect.innerHTML = '<option value="">All Classes</option>';
                data.classes.forEach(cls => {
                    const option = document.createElement("option");
                    option.value = cls;
                    option.textContent = cls;
                    if (cls === selected) option.selected = true;
                    classSelect.appendChild(option);
                });
            });
    }

    schoolSelect.addEventListener("change", updateClasses);
    yearSelect.addEventListener("change", updateClasses);
});
</script>

{% endblock %}
